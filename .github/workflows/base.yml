name: Base pipeline

# триггер запуска
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

# этапы пайплайны - они же "джобы" (jobs)
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Restore
        run: dotnet restore
      - name: Lint (verify no changes)
        run: dotnet format --verify-no-changes
  test:
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Restore
        run: dotnet restore
      - name: Run unit tests
        run: dotnet test CurrencyConvertApiAppUnitTests/CurrencyConvertApiAppUnitTests.csproj --nologo --configuration Release --verbosity minimal
  build-windows:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Publish (win-x64)
        run: |
          dotnet publish CurrencyConvertApiApp/CurrencyConvertApiApp.csproj -c Release -r win-x64 --self-contained false -o bin/win-x64
      - name: Create zip artifact
        run: |
          mkdir -p bin
          cd bin
          zip -r CurrencyConvertApiApp-win-x64.zip win-x64
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CurrencyConvertApiApp-win-x64
          path: bin/CurrencyConvertApiApp-win-x64.zip
